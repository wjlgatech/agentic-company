{
  "run_id": "4b801f8c",
  "artifacts": [
    {
      "type": "test",
      "filename": "tests/conftest.py",
      "content": "# tests/conftest.py\n\"\"\"\nTest configuration and fixtures\n\"\"\"\nimport pytest\nimport asyncio\nfrom typing import AsyncGenerator\nfrom sqlalchemy.ext.asyncio import create_async_engine, AsyncSession, async_sessionmaker\nfrom sqlalchemy.pool import StaticPool\nfrom httpx import AsyncClient\nfrom fastapi.testclient import TestClient\n\nfrom main import app\nfrom core.database import Base, get_db\nfrom models.user import User\nfrom models.portfolio import Portfolio, Position\nfrom models.trade import Trade, TradeType, TradeStatus, OrderType\n\n# Test database URL\nTEST_DATABASE_URL = \"sqlite+aiosqlite:///:memory:\"\n\n# Create test engine\ntest_engine = create_async_engine(\n    TEST_DATABASE_URL,\n    poolclass=StaticPool,\n    connect_args={\"check_same_thread\": False},\n    echo=False\n)\n\nTestSessionLocal = async_sessionmaker(\n    test_engine,\n    class_=AsyncSession,\n    expire_on_commit=False\n)\n\n@pytest.fixture(scope=\"session\")\ndef event_loop():\n    \"\"\"Create an instance of the default event loop for the test session.\"\"\"\n    loop = asyncio.get_event_loop_policy().new_event_loop()\n    yield loop\n    loop.close()\n\n@pytest.fixture\nasync def db_session() -> AsyncGenerator[AsyncSession, None]:\n    \"\"\"Create a test database session\"\"\"\n    async with test_engine.begin() as conn:\n        await conn.run_sync(Base.metadata.create_all)\n    \n    async with TestSessionLocal() as session:\n        yield session\n    \n    async with test_engine.begin() as conn:\n        await conn.run_sync(Base.metadata.drop_all)\n\n@pytest.fixture\nasync def client(db_session: AsyncSession) -> AsyncGenerator[AsyncClient, None]:\n    \"\"\"Create a test client with database dependency override\"\"\"\n    \n    async def override_get_db():\n        yield db_session\n    \n    app.dependency_overrides[get_db] = override_get_db\n    \n    async with AsyncClient(app=app, base_url=\"http://test\") as client:\n        yield client\n    \n    app.dependency_overrides.clear()\n\n@pytest.fixture\nasync def test_user(db_session: AsyncSession) -> User:\n    \"\"\"Create a test user\"\"\"\n    user = User(\n        email=\"test@example.com\",\n        username=\"testuser\",\n        hashed_password=User.hash_password(\"testpass123\"),\n        first_name=\"Test\",\n        last_name=\"User\",\n        is_active=True,\n        is_verified=True,\n        can_trade_stocks=True,\n        can_trade_crypto=True\n    )\n    db_session.add(user)\n    await db_session.commit()\n    await db_session.refresh(user)\n    return user\n\n@pytest.fixture\nasync def test_portfolio(db_session: AsyncSession, test_user: User) -> Portfolio:\n    \"\"\"Create a test portfolio\"\"\"\n    portfolio = Portfolio(\n        user_id=test_user.id,\n        name=\"Test Portfolio\",\n        description=\"Test portfolio for unit tests\",\n        cash_balance=10000.0,\n        is_active=True\n    )\n    db_session.add(portfolio)\n    await db_session.commit()\n    await db_session.refresh(portfolio)\n    return portfolio\n\n@pytest.fixture\nasync def test_position(db_session: AsyncSession, test_portfolio: Portfolio) -> Position:\n    \"\"\"Create a test position\"\"\"\n    position = Position(\n        portfolio_id=test_portfolio.id,\n        symbol=\"AAPL\",\n        asset_type=\"stock\",\n        quantity=10.0,\n        average_price=150.0,\n        current_price=155.0,\n        market_value=1550.0,\n        unrealized_pnl=50.0,\n        unrealized_pnl_pct=3.33\n    )\n    db_session.add(position)\n    await db_session.commit()\n    await db_session.refresh(position)\n    return position",
      "language": "python",
      "metadata": {
        "extracted_from": "code_block",
        "index": 0
      },
      "created_at": "2026-02-15T07:55:45.272470"
    },
    {
      "type": "test",
      "filename": "tests/test_models.py",
      "content": "# tests/test_models.py\n\"\"\"\nUnit tests for database models\n\"\"\"\nimport pytest\nfrom datetime import datetime\nfrom models.user import User\nfrom models.portfolio import Portfolio, Position\nfrom models.trade import Trade, TradeType, TradeStatus, OrderType\n\nclass TestUserModel:\n    \"\"\"Test User model functionality\"\"\"\n    \n    def test_user_creation(self):\n        \"\"\"Test user instance creation\"\"\"\n        user = User(\n            email=\"test@example.com\",\n            username=\"testuser\",\n            hashed_password=\"hashed_password\",\n            first_name=\"Test\",\n            last_name=\"User\"\n        )\n        \n        assert user.email == \"test@example.com\"\n        assert user.username == \"testuser\"\n        assert user.first_name == \"Test\"\n        assert user.last_name == \"User\"\n        assert user.is_active == True\n        assert user.is_verified == False\n        assert user.is_admin == False\n    \n    def test_password_hashing(self):\n        \"\"\"Test password hashing and verification\"\"\"\n        password = \"testpass123\"\n        hashed = User.hash_password(password)\n        \n        assert hashed != password\n        assert len(hashed) > 20\n        \n        user = User(\n            email=\"test@example.com\",\n            username=\"testuser\",\n            hashed_password=hashed,\n            first_name=\"Test\",\n            last_name=\"User\"\n        )\n        \n        assert user.verify_password(password) == True\n        assert user.verify_password(\"wrongpass\") == False\n    \n    def test_user_defaults(self):\n        \"\"\"Test user default values\"\"\"\n        user = User(\n            email=\"test@example.com\",\n            username=\"testuser\",\n            hashed_password=\"hash\",\n            first_name=\"Test\",\n            last_name=\"User\"\n        )\n        \n        assert user.max_position_size == 0.05\n        assert user.max_daily_loss == 0.02\n        assert user.can_trade_stocks == False\n        assert user.can_trade_crypto == False\n\nclass TestPortfolioModel:\n    \"\"\"Test Portfolio model functionality\"\"\"\n    \n    def test_portfolio_creation(self):\n        \"\"\"Test portfolio instance creation\"\"\"\n        portfolio = Portfolio(\n            user_id=1,\n            name=\"Test Portfolio\",\n            description=\"A test portfolio\",\n            cash_balance=10000.0\n        )\n        \n        assert portfolio.user_id == 1\n        assert portfolio.name == \"Test Portfolio\"\n        assert portfolio.cash_balance == 10000.0\n        assert portfolio.total_value == 0.0\n        assert portfolio.is_active == True\n        assert portfolio.auto_trading_enabled == False\n    \n    def test_portfolio_metrics_defaults(self):\n        \"\"\"Test portfolio metrics default values\"\"\"\n        portfolio = Portfolio(\n            user_id=1,\n            name=\"Test Portfolio\"\n        )\n        \n        assert portfolio.beta == 1.0\n        assert portfolio.sharpe_ratio == 0.0\n        assert portfolio.max_drawdown == 0.0\n        assert portfolio.volatility == 0.0\n\nclass TestPositionModel:\n    \"\"\"Test Position model functionality\"\"\"\n    \n    def test_position_creation(self):\n        \"\"\"Test position instance creation\"\"\"\n        position = Position(\n            portfolio_id=1,\n            symbol=\"AAPL\",\n            asset_type=\"stock\",\n            quantity=10.0,\n            average_price=150.0\n        )\n        \n        assert position.portfolio_id == 1\n        assert position.symbol == \"AAPL\"\n        assert position.asset_type == \"stock\"\n        assert position.quantity == 10.0\n        assert position.average_price == 150.0\n        assert position.current_price == 0.0\n        assert position.unrealized_pnl == 0.0\n\nclass TestTradeModel:\n    \"\"\"Test Trade model functionality\"\"\"\n    \n    def test_trade_creation(self):\n        \"\"\"Test trade instance creation\"\"\"\n        trade = Trade(\n            user_id=1,\n            portfolio_id=1,\n            symbol=\"AAPL\",\n            asset_type=\"stock\",\n            trade_type=TradeType.BUY,\n            order_type=OrderType.MARKET,\n            quantity=10.0\n        )\n        \n        assert trade.user_id == 1\n        assert trade.portfolio_id == 1\n        assert trade.symbol == \"AAPL\"\n        assert trade.trade_type == TradeType.BUY\n        assert trade.order_type == OrderType.MARKET\n        assert trade.quantity == 10.0\n        assert trade.status == TradeStatus.PENDING\n    \n    def test_trade_enums(self):\n        \"\"\"Test trade enum values\"\"\"\n        assert TradeType.BUY == \"buy\"\n        assert TradeType.SELL == \"sell\"\n        \n        assert TradeStatus.PENDING == \"pending\"\n        assert TradeStatus.FILLED == \"filled\"\n        assert TradeStatus.CANCELLED == \"cancelled\"\n        \n        assert OrderType.MARKET == \"market\"\n        assert OrderType.LIMIT == \"limit\"",
      "language": "python",
      "metadata": {
        "extracted_from": "code_block",
        "index": 1
      },
      "created_at": "2026-02-15T07:55:45.272524"
    },
    {
      "type": "test",
      "filename": "tests/test_auth_api.py",
      "content": "# tests/test_auth_api.py\n\"\"\"\nIntegration tests for authentication API endpoints\n\"\"\"\nimport pytest\nfrom httpx import AsyncClient\nfrom models.user import User\n\nclass TestAuthAPI:\n    \"\"\"Test authentication endpoints\"\"\"\n    \n    async def test_health_check(self, client: AsyncClient):\n        \"\"\"Test health check endpoint\"\"\"\n        response = await client.get(\"/health\")\n        assert response.status_code == 200\n        data = response.json()\n        assert data[\"status\"] == \"healthy\"\n        assert \"version\" in data\n    \n    async def test_register_user(self, client: AsyncClient):\n        \"\"\"Test user registration\"\"\"\n        user_data = {\n            \"email\": \"newuser@example.com\",\n            \"username\": \"newuser\",\n            \"password\": \"testpass123\",\n            \"first_name\": \"New\",\n            \"last_name\": \"User\"\n        }\n        \n        response = await client.post(\"/api/v1/auth/register\", json=user_data)\n        assert response.status_code == 201\n        data = response.json()\n        assert data[\"email\"] == user_data[\"email\"]\n        assert data[\"username\"] == user_data[\"username\"]\n        assert \"id\" in data\n        assert \"password\" not in data\n    \n    async def test_register_duplicate_email(self, client: AsyncClient, test_user: User):\n        \"\"\"Test registration with duplicate email\"\"\"\n        user_data = {\n            \"email\": test_user.email,\n            \"username\": \"different\",\n            \"password\": \"testpass123\",\n            \"first_name\": \"Test\",\n            \"last_name\": \"User\"\n        }\n        \n        response = await client.post(\"/api/v1/auth/register\", json=user_data)\n        assert response.status_code == 400\n        assert \"already registered\" in response.json()[\"detail\"]\n    \n    async def test_login_success(self, client: AsyncClient, test_user: User):\n        \"\"\"Test successful login\"\"\"\n        login_data = {\n            \"username\": test_user.email,\n            \"password\": \"testpass123\"\n        }\n        \n        response = await client.post(\"/api/v1/auth/login\", data=login_data)\n        assert response.status_code == 200\n        data = response.json()\n        assert \"access_token\" in data\n        assert \"refresh_token\" in data\n        assert data[\"token_type\"] == \"bearer\"\n    \n    async def test_login_invalid_credentials(self, client: AsyncClient, test_user: User):\n        \"\"\"Test login with invalid credentials\"\"\"\n        login_data = {\n            \"username\": test_user.email,\n            \"password\": \"wrongpassword\"\n        }\n        \n        response = await client.post(\"/api/v1/auth/login\", data=login_data)\n        assert response.status_code == 401\n        assert \"Invalid credentials\" in response.json()[\"detail\"]\n    \n    async def test_login_nonexistent_user(self, client: AsyncClient):\n        \"\"\"Test login with non-existent user\"\"\"\n        login_data = {\n            \"username\": \"nonexistent@example.com\",\n            \"password\": \"password\"\n        }\n        \n        response = await client.post(\"/api/v1/auth/login\", data=login_data)\n        assert response.status_code == 401\n    \n    async def test_get_current_user(self, client: AsyncClient, test_user: User):\n        \"\"\"Test getting current user info\"\"\"\n        # First login to get token\n        login_data = {\n            \"username\": test_user.email,\n            \"password\": \"testpass123\"\n        }\n        login_response = await client.post(\"/api/v1/auth/login\", data=login_data)\n        token = login_response.json()[\"access_token\"]\n        \n        # Get current user\n        headers = {\"Authorization\": f\"Bearer {token}\"}\n        response = await client.get(\"/api/v1/auth/me\", headers=headers)\n        assert response.status_code == 200\n        data = response.json()\n        assert data[\"email\"] == test_user.email\n        assert data[\"username\"] == test_user.username\n    \n    async def test_get_current_user_invalid_token(self, client: AsyncClient):\n        \"\"\"Test getting current user with invalid token\"\"\"\n        headers = {\"Authorization\": \"Bearer invalid_token\"}\n        response = await client.get(\"/api/v1/auth/me\", headers=headers)\n        assert response.status_code == 401",
      "language": "python",
      "metadata": {
        "extracted_from": "code_block",
        "index": 2
      },
      "created_at": "2026-02-15T07:55:45.272563"
    }
  ],
  "created_at": "2026-02-15T07:55:45.272589",
  "metadata": {},
  "stats": {
    "count": 3,
    "total_size_bytes": 12289,
    "total_lines": 380
  }
}